name: Backend Deploy

on:
  push:
    branches: [ be ]  # be ë¸Œëœì¹˜ì— í‘¸ì‹œë˜ë©´ ì‹¤í–‰
  workflow_dispatch:

env:
  DOCKER_IMAGE: seuraseung-backend
  CONTAINER_NAME: seuraseung-backend-container

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    
    steps:
    # 1. be ë¸Œëœì¹˜ì—ì„œ ë°±ì—”ë“œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
    - name: Checkout backend code
      uses: actions/checkout@v4
      with:
        ref: be
        path: backend-source
    
    # 2. cicd ë¸Œëœì¹˜ì—ì„œ ë„ì»¤íŒŒì¼ ê°€ì ¸ì˜¤ê¸°  
    - name: Checkout cicd configs
      uses: actions/checkout@v4
      with:
        ref: cicd
        path: cicd-configs
    
    # 3. ë°±ì—”ë“œ ì½”ë“œì— ë„ì»¤íŒŒì¼ ë³µì‚¬
    - name: Copy Dockerfile to backend
      run: |
        cp cicd-configs/dockerfiles/Dockerfile.backend backend-source/Dockerfile
        ls -la backend-source/
    
    # 4. JDK 21 ì„¤ì •
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    # 5. ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸ (ì„ íƒì‚¬í•­)
    - name: Test backend
      working-directory: ./backend-source
      run: |
        if [ -f "./mvnw" ]; then
          chmod +x ./mvnw
          ./mvnw clean test -DskipTests  # ì¼ë‹¨ í…ŒìŠ¤íŠ¸ ìŠ¤í‚µ
        else
          echo "âš ï¸ mvnw not found, skipping tests"
        fi
    
    # 6. Docker ì´ë¯¸ì§€ ë¹Œë“œ
    - name: Build Docker image
      working-directory: ./backend-source
      run: |
        docker build -t $DOCKER_IMAGE:latest .
        docker tag $DOCKER_IMAGE:latest $DOCKER_IMAGE:${{ github.sha }}
    
    # 7. Docker ì´ë¯¸ì§€ ì €ì¥
    - name: Save Docker image
      run: |
        docker save $DOCKER_IMAGE:latest | gzip > backend-image.tar.gz
    
    # 8. ë°±ì—”ë“œ ì„œë²„ì— ë°°í¬ ì¤€ë¹„
    - name: Deploy to Backend Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.BACKEND_HOST }}
        username: ${{ secrets.BACKEND_USER }}
        key: ${{ secrets.BACKEND_SSH_KEY }}
        port: 22
        script: |
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          docker stop ${{ env.CONTAINER_NAME }} || true
          docker rm ${{ env.CONTAINER_NAME }} || true
          docker rmi ${{ env.DOCKER_IMAGE }}:latest || true
          
          # ì´ì „ ì´ë¯¸ì§€ íŒŒì¼ ì •ë¦¬
          rm -f /tmp/backend-image.tar.gz
    
    # 9. Docker ì´ë¯¸ì§€ ì„œë²„ë¡œ ë³µì‚¬
    - name: Copy Docker image to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.BACKEND_HOST }}
        username: ${{ secrets.BACKEND_USER }}
        key: ${{ secrets.BACKEND_SSH_KEY }}
        port: 22
        source: "backend-image.tar.gz"
        target: "/tmp/"
    
    # 10. ì„œë²„ì—ì„œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
    - name: Load and run Docker container
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.BACKEND_HOST }}
        username: ${{ secrets.BACKEND_USER }}
        key: ${{ secrets.BACKEND_SSH_KEY }}
        port: 22
        script: |
          # Docker ì´ë¯¸ì§€ ë¡œë“œ
          cd /tmp
          docker load < backend-image.tar.gz
          
          # ë„¤íŠ¸ì›Œí¬ ìƒì„± (ì—†ìœ¼ë©´)
          docker network create seuraseung-network || true
          
          # ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            --network seuraseung-network \
            -p 8080:8080 \
            -e SPRING_PROFILES_ACTIVE=prod \
            -e SPRING_DATASOURCE_URL=jdbc:postgresql://localhost:5432/seurasaeng?currentSchema=seurasaeng-prod \
            -e SPRING_DATASOURCE_USERNAME=postgres \
            -e SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }} \
            -e SPRING_REDIS_HOST=localhost \
            -e SPRING_REDIS_PORT=6379 \
            -e SPRING_REDIS_DATABASE=0 \
            --restart unless-stopped \
            ${{ env.DOCKER_IMAGE }}:latest
          
          # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
          echo "â³ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          sleep 15
          
          # í—¬ìŠ¤ì²´í¬
          for i in {1..30}; do
            if curl -f http://localhost:8080/api/health; then
              echo "âœ… ë°±ì—”ë“œ ë°°í¬ ì„±ê³µ!"
              break
            fi
            echo "ëŒ€ê¸° ì¤‘... ($i/30)"
            sleep 2
          done
          
          # ì •ë¦¬
          rm -f /tmp/backend-image.tar.gz
          
          # ìƒíƒœ í™•ì¸
          docker ps | grep seuraseung-backend
          echo "ğŸ‰ ë°±ì—”ë“œ ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ”§ ë°±ì—”ë“œ API: http://10.0.2.165:8080/api/health"
