name: Frontend Deploy

on:
  push:
    branches: [ fe ]  # fe ë¸Œëœì¹˜ì— í‘¸ì‹œë˜ë©´ ì‹¤í–‰
  workflow_dispatch:

env:
  DOCKER_IMAGE: seuraseung-frontend
  CONTAINER_NAME: seuraseung-frontend-container

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    
    steps:
    # 1. fe ë¸Œëœì¹˜ì—ì„œ í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
    - name: Checkout frontend code
      uses: actions/checkout@v4
      with:
        ref: fe
        path: frontend-source
    
    # 2. cicd ë¸Œëœì¹˜ì—ì„œ ë„ì»¤íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
    - name: Checkout cicd configs
      uses: actions/checkout@v4
      with:
        ref: cicd
        path: cicd-configs
    
    # 3. í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œì— ë„ì»¤íŒŒì¼ê³¼ nginx ì„¤ì • ë³µì‚¬
    - name: Copy Docker configs to frontend
      run: |
        cp cicd-configs/dockerfiles/Dockerfile.frontend frontend-source/Dockerfile
        cp cicd-configs/dockerfiles/nginx.conf frontend-source/nginx.conf
        ls -la frontend-source/
    
    # 4. Node.js ì„¤ì •
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    # 5. í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸ (ì„ íƒì‚¬í•­)
    - name: Test frontend
      working-directory: ./frontend-source
      run: |
        if [ -f "package.json" ]; then
          npm ci
          npm test -- --watchAll=false --coverage=false || echo "âš ï¸ í…ŒìŠ¤íŠ¸ ìŠ¤í‚µ"
        else
          echo "âš ï¸ package.json not found, skipping tests"
        fi
    
    # 6. Docker ì´ë¯¸ì§€ ë¹Œë“œ
    - name: Build Docker image
      working-directory: ./frontend-source
      run: |
        docker build -t $DOCKER_IMAGE:latest .
        docker tag $DOCKER_IMAGE:latest $DOCKER_IMAGE:${{ github.sha }}
    
    # 7. Docker ì´ë¯¸ì§€ ì €ì¥
    - name: Save Docker image
      run: |
        docker save $DOCKER_IMAGE:latest | gzip > frontend-image.tar.gz
    
    # 8. í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ì— ë°°í¬ ì¤€ë¹„
    - name: Deploy to Frontend Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.FRONTEND_HOST }}
        username: ${{ secrets.FRONTEND_USER }}
        key: ${{ secrets.FRONTEND_SSH_KEY }}
        port: 22
        script: |
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          docker stop ${{ env.CONTAINER_NAME }} || true
          docker rm ${{ env.CONTAINER_NAME }} || true
          docker rmi ${{ env.DOCKER_IMAGE }}:latest || true
          
          # ì´ì „ ì´ë¯¸ì§€ íŒŒì¼ ì •ë¦¬
          rm -f /tmp/frontend-image.tar.gz
    
    # 9. Docker ì´ë¯¸ì§€ ì„œë²„ë¡œ ë³µì‚¬
    - name: Copy Docker image to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.FRONTEND_HOST }}
        username: ${{ secrets.FRONTEND_USER }}
        key: ${{ secrets.FRONTEND_SSH_KEY }}
        port: 22
        source: "frontend-image.tar.gz"
        target: "/tmp/"
    
    # 10. ì„œë²„ì—ì„œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
    - name: Load and run Docker container
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.FRONTEND_HOST }}
        username: ${{ secrets.FRONTEND_USER }}
        key: ${{ secrets.FRONTEND_SSH_KEY }}
        port: 22
        script: |
          # Docker ì´ë¯¸ì§€ ë¡œë“œ
          cd /tmp
          docker load < frontend-image.tar.gz
          
          # ë„¤íŠ¸ì›Œí¬ ìƒì„± (ì—†ìœ¼ë©´)
          docker network create seuraseung-network || true
          
          # í”„ë¡ íŠ¸ì—”ë“œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            --network seuraseung-network \
            -p 80:80 \
            --restart unless-stopped \
            ${{ env.DOCKER_IMAGE }}:latest
          
          # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
          echo "â³ í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          sleep 10
          
          # í—¬ìŠ¤ì²´í¬
          for i in {1..30}; do
            if curl -f http://localhost/health; then
              echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì„±ê³µ!"
              break
            fi
            echo "ëŒ€ê¸° ì¤‘... ($i/30)"
            sleep 2
          done
          
          # ì •ë¦¬
          rm -f /tmp/frontend-image.tar.gz
          
          # ìƒíƒœ í™•ì¸
          docker ps | grep seuraseung-frontend
          echo "ğŸ‰ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì™„ë£Œ!"
          echo "ğŸŒ ì‚¬ì´íŠ¸ ì ‘ì†: http://13.125.3.120"
